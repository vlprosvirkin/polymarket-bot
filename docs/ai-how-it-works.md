# Как работает AI Market Scorer: Источники данных и фильтрация

## Текущая реализация (Без внешних новостей)

### ⚠️ Важно понимать:
**AI Market Scorer НЕ берет новости из внешних источников**. Он анализирует только данные из Polymarket API и использует знания, заложенные в модель во время обучения.

---

## 1. Откуда берутся данные?

### Данные из Polymarket API
AI получает только то, что передается в промпт:

```typescript
// Данные, которые передаются AI:
- market.question        // Вопрос рынка (например: "Will Biden win 2024 election?")
- market.description    // Описание рынка
- market.tokens[].price // Текущие цены YES/NO токенов
- market.end_date_iso   // Дата разрешения рынка
- market.category       // Категория (politics, sports, etc.)
- market.tags           // Теги
- market.active         // Активен ли рынок
- market.neg_risk       // NegRisk рынок
- Дни до разрешения (вычисляется)
```

### Внутренние знания AI модели
Модели (GPT-4o, Gemini) имеют знания до определенной даты обучения:
- **GPT-4o**: обучен на данных до апреля 2024
- **Gemini**: обучен на данных до текущего момента (зависит от версии)

Эти знания включают:
- Исторические факты
- Общие закономерности рынков
- Понимание контекста вопросов
- Анализ формулировок на предмет неоднозначности

### Что AI НЕ знает:
- ❌ Свежие новости (после даты обучения)
- ❌ Текущие рыночные тренды в реальном времени
- ❌ Специфичные данные о конкретных событиях "сегодня"

---

## 2. Как работает фильтрация?

### Шаг 1: Анализ данных рынка

AI анализирует переданные данные и делает выводы:

```typescript
// Пример промпта, который отправляется AI:
"Analyze this prediction market:
- Question: Will Trump win 2024 election?
- YES Price: 95%
- Days to Resolution: 3 days
- Category: Politics

Provide score, reasoning, and risk factors."
```

### Шаг 2: AI использует свои знания

AI применяет внутренние знания для анализа:

**Анализ вопроса:**
- Ясность формулировки ("Will X win election?" - четкий вопрос)
- Проверяемость (можно ли однозначно разрешить?)
- Время разрешения (если 3 дня до выборов - высокий риск)

**Анализ цены:**
- Цена 95% для выборов за 3 дня может быть:
  - ✅ Разумной, если опросы показывают лидерство
  - ⚠️ Завышенной, если есть неопределенность
  - ❌ Риск манипуляции, если цена резко выросла

**Анализ рисков:**
- AI определяет риски на основе:
  - Формулировки вопроса (неоднозначные = риск)
  - Категории (политика = выше волатильность)
  - Времени до разрешения (близко = риск)

### Шаг 3: Генерация оценки

AI возвращает структурированную оценку:

```json
{
  "score": 0.75,
  "confidence": 0.8,
  "reasoning": "High probability outcome with clear resolution criteria. Market shows strong consensus. However, political markets have inherent volatility.",
  "riskFactors": [
    "Political event - higher volatility expected",
    "Close to resolution date - limited time for exit"
  ],
  "opportunities": [
    "Strong market consensus at 95%",
    "Clear resolution mechanism"
  ]
}
```

### Шаг 4: Фильтрация по score

Ваш код фильтрует рынки по AI score:

```typescript
const scored = await aiScorer.scoreMarkets(markets);
const filtered = scored
    .filter(item => item.score.score >= 0.7) // Минимальный score
    .sort((a, b) => b.score.score - a.score.score) // Сортировка
    .slice(0, maxMarkets); // Топ N рынков
```

---

## 3. Что AI анализирует при фильтрации?

### A. Качество вопроса
- ✅ **Хорошо**: "Will event X happen on date Y?" - четкий, проверяемый
- ⚠️ **Плохо**: "Will something happen?" - неопределенный
- ❌ **Очень плохо**: "Will market go up?" - субъективный

### B. Критерии разрешения
- ✅ Четкие критерии = высокий score
- ⚠️ Неясные критерии = низкий score, риск неразрешения

### C. Время до разрешения
- Рынки близко к разрешению (1-7 дней):
  - ✅ Выше ликвидность
  - ⚠️ Меньше времени для выхода
  - ❌ Выше риск резких движений

### D. Ценовая эффективность
- AI оценивает, соответствует ли цена:
  - Историческим паттернам
  - Сложности вопроса
  - Категории рынка

### E. Категория и теги
- Политика: высокий риск, высокая волатильность
- Спорт: более предсказуемо
- Крипто: очень волатильно

---

## 4. Ограничения текущей реализации

### ❌ Нет доступа к свежим новостям
AI не знает, что произошло "вчера" или "сегодня", если это после даты обучения.

**Пример:**
- Рынок: "Will Company X release product Y in Q4 2024?"
- Если новость о задержке вышла вчера, AI этого не знает
- AI оценит на основе общих паттернов, но не свежих данных

### ✅ Решение: Интеграция новостных API

Можно добавить источники новостей:

1. **NewsAPI** (newsapi.org)
   - Бесплатный план: 100 запросов/день
   - Источники: 80,000+ новостных источников

2. **Alpha Vantage News & Sentiment**
   - Финансовые новости
   - Анализ настроений

3. **Google News RSS** (бесплатно)
   - Парсинг RSS фидов
   - По категориям/ключевым словам

4. **Twitter API** (если нужны социальные сигналы)
   - Тренды по хештегам
   - Анализ настроений

---

## 5. Как улучшить фильтрацию с новостями?

### Вариант A: Обогащение данных перед отправкой AI

```typescript
class EnhancedAIMarketScorer {
    private newsService: NewsService;
    
    async scoreMarket(market: Market): Promise<MarketScore> {
        // 1. Получаем свежие новости, связанные с рынком
        const keywords = this.extractKeywords(market.question);
        const recentNews = await this.newsService.getRecentNews(keywords, {
            hours: 24 // Новости за последние 24 часа
        });
        
        // 2. Добавляем новости в промпт для AI
        const prompt = this.buildPrompt(market, {
            recentNews: recentNews.map(n => ({
                title: n.title,
                summary: n.summary,
                sentiment: n.sentiment, // positive/negative/neutral
                relevance: n.relevanceScore
            }))
        });
        
        // 3. AI анализирует с учетом новостей
        return await this.aiService.generateResponse(prompt);
    }
}
```

### Вариант B: Двухэтапная фильтрация

```typescript
async filterMarkets(markets: Market[]): Promise<Market[]> {
    // Этап 1: Быстрая фильтрация AI (без новостей)
    const aiScored = await this.aiScorer.scoreMarkets(markets);
    const topMarkets = aiScored
        .filter(s => s.score.score >= 0.6)
        .slice(0, 20); // Топ 20
    
    // Этап 2: Углубленный анализ с новостями для топ-кандидатов
    const enhancedScores = await Promise.all(
        topMarkets.map(async (item) => {
            const news = await this.fetchRelevantNews(item.market);
            const enhancedScore = await this.scoreWithNews(item.market, news);
            return { ...item, score: enhancedScore };
        })
    );
    
    // Финальная фильтрация
    return enhancedScores
        .filter(s => s.score.score >= 0.7)
        .slice(0, 5)
        .map(s => s.market);
}
```

---

## 6. Как AI определяет "хорошие" рынки?

### Критерии высокой оценки (score > 0.8):

1. **Четкий вопрос**
   - Однозначная формулировка
   - Конкретная дата/событие
   - Объективные критерии разрешения

2. **Разумная цена**
   - Соответствует сложности вопроса
   - Нет явных арбитражных возможностей
   - Консенсус рынка выглядит обоснованным

3. **Хорошая ликвидность (если данные есть)**
   - Небольшой спред
   - Достаточный объем ордеров
   - Активная торговля

4. **Оптимальное время**
   - Достаточно времени для анализа (не слишком рано)
   - Не слишком близко к разрешению (риск)
   - Идеально: 7-30 дней до разрешения

5. **Низкий риск манипуляции**
   - Не NegRisk рынок (если excludeNegRisk=true)
   - Репутационная категория
   - Устоявшиеся правила разрешения

### Критерии низкой оценки (score < 0.5):

1. **Неопределенный вопрос**
   - Субъективные формулировки
   - Неясные критерии разрешения
   - Множественные интерпретации

2. **Подозрительная цена**
   - Резкие необоснованные движения
   - Значительные арбитражные возможности
   - Расхождение с ожиданиями

3. **Высокий риск**
   - Политические события (высокая волатильность)
   - Слишком близко к разрешению
   - Недостаточная ликвидность

4. **Плохое качество рынка**
   - NegRisk рынки
   - Неясные правила
   - Проблемы с разрешением в прошлом

---

## 7. Пример работы фильтрации

### Сценарий: Выбор между 3 рынками

**Рынок A:**
- Question: "Will Bitcoin reach $100k by Dec 31, 2024?"
- Price: 85%
- Days: 45
- Category: Crypto

**AI Анализ:**
- ✅ Четкий вопрос, конкретная дата
- ⚠️ Крипто = высокая волатильность
- ⚠️ 45 дней - достаточно времени
- ⚠️ Цена 85% может быть завышена
- **Score: 0.65**

**Рынок B:**
- Question: "Will Team X win the championship on date Y?"
- Price: 92%
- Days: 7
- Category: Sports

**AI Анализ:**
- ✅ Четкий вопрос, объективные критерии
- ✅ Спорт = более предсказуемо
- ⚠️ Очень близко к разрешению (7 дней)
- ✅ Цена соответствует вероятности
- **Score: 0.78**

**Рынок C:**
- Question: "Will something good happen?"
- Price: 60%
- Days: 30
- Category: Politics

**AI Анализ:**
- ❌ Неопределенный вопрос
- ❌ Нет критериев разрешения
- ⚠️ Политика = риск
- ❌ Низкая цена может означать неопределенность
- **Score: 0.25**

**Результат фильтрации (minScore = 0.7):**
- ✅ Рынок B выбран (score: 0.78)
- ❌ Рынок A отфильтрован (score: 0.65)
- ❌ Рынок C отфильтрован (score: 0.25)

---

## 8. Как добавить интеграцию с новостями?

Если вы хотите добавить реальные новости, я могу создать:

1. **NewsService** - сервис для получения новостей
2. **EnhancedAIMarketScorer** - версию с новостями
3. **News Aggregator** - агрегацию из нескольких источников

Скажите, какой вариант вас интересует?

