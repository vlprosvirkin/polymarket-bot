# Endgame Strategy

Стратегия хеджирования для рынков с высокой вероятностью, близких к разрешению.

## Концепция

**Endgame Strategy** - арбитражная стратегия для событий на "финишной прямой", где исход практически определен (95-99% вероятность), но есть риск "черного лебедя".

### Основная идея:
1. Находим рынки с вероятностью YES 95-99%
2. Покупаем большую позицию в YES (основная ставка)
3. Покупаем страховочную позицию в NO (хедж от катастрофы)
4. Ждем разрешения рынка

### Пример:
Рынок: "Bitcoin выше $50k 31 декабря?"
- Цена YES: 97% ($0.97)
- Цена NO: 3% ($0.03)
- До разрешения: 5 дней

**Без хеджа:**
- Покупаем 100 YES @ $0.97 = $97
- Если выиграет: получаем $100, прибыль = $3 (3%)
- Если проиграет: теряем $97 (100% убыток)

**С хеджем:**
- Покупаем 100 YES @ $0.97 = $97
- Покупаем 25 NO @ $0.03 = $0.75 (страховка)
- Всего: $97.75
- Если YES выиграет: прибыль = $3 - $0.75 = $2.25 (2.3%)
- Если NO выиграет: убыток = -$97 + $24.25 = -$72.75 (но защищены от полного краха!)

---

## Параметры конфигурации

### EndgameConfig

```typescript
interface EndgameConfig {
    // Базовые параметры стратегии
    orderSize: number;              // Размер позиции в USDC
    maxPosition: number;            // Максимальный размер портфеля
    minVolume: number;              // Минимальный объем рынка
    maxMarkets: number;             // Максимум рынков одновременно
    excludeNegRisk: boolean;        // Исключить NegRisk рынки

    // Специфичные для Endgame
    maxAcceptableLoss: number;      // Максимальный приемлемый убыток (0.2 = 20%)
    minProbability: number;         // Минимальная вероятность (0.95 = 95%)
    maxProbability: number;         // Максимальная вероятность (0.99 = 99%)
    maxDaysToResolution: number;    // Максимум дней до разрешения
    earlyExitThreshold: number;     // Порог раннего выхода (0.99 = 99%)
}
```

### Типичные значения:

**Консервативная конфигурация:**
- `minProbability: 0.95` (95%)
- `maxProbability: 0.99` (99%)
- `maxAcceptableLoss: 0.10` (10% максимальный убыток)
- `maxDaysToResolution: 7` (неделя до разрешения)
- `orderSize: 100` ($100 на позицию)

**Агрессивная конфигурация:**
- `minProbability: 0.80` (80%)
- `maxProbability: 0.99` (99%)
- `maxAcceptableLoss: 0.20` (20% максимальный убыток)
- `maxDaysToResolution: 30` (месяц до разрешения)
- `orderSize: 1000` ($1000 на позицию)

---

## Фильтрация рынков

### Критерии отбора (все должны выполняться):

1. **Статус рынка:**
   - `active = true` - рынок активен
   - `closed = false` - не закрыт
   - `accepting_orders = true` - принимает ордера

2. **Наличие токенов:**
   - `tokens.length > 0` - есть YES/NO токены

3. **Объем торговли:**
   - `volume >= minVolume` - минимальный объем (например $1000)
   - ⚠️ API не возвращает volume, используйте ликвидность из orderbook

4. **NegRisk фильтр:**
   - `!neg_risk` - исключаем NegRisk рынки (если `excludeNegRisk = true`)

5. **Дата разрешения (ОБЯЗАТЕЛЬНО):**
   - `end_date_iso != null` - должна быть четкая дата
   - `daysUntilEnd <= maxDaysToResolution` - разрешение в ближайшие N дней
   - `daysUntilEnd >= 0` - не просроченный

6. **Вероятность (ГЛАВНЫЙ ФИЛЬТР):**
   - `yesPrice >= minProbability` - минимум 95%
   - `yesPrice <= maxProbability` - максимум 99%
   - Диапазон 95-99% = "почти уверенный исход с риском черного лебедя"

### Лимиты:
- Берем топ `maxMarkets` рынков после фильтрации

---

## Алгоритм принятия решения

### Шаг 1: Фильтрация рынков
```
getSamplingMarkets()
→ фильтруем по критериям
→ топ maxMarkets рынков
```

### Шаг 2: Проверка позиции
```
Если уже есть позиция в рынке → SKIP
Если price вне диапазона [minProbability, maxProbability] → SKIP
```

### Шаг 3: Расчет хеджа
```
calculateHedgePosition(orderSize, yesPrice, maxAcceptableLoss)
→ возвращает размеры YES и NO позиций
```

### Шаг 4: Генерация сигналов
```
Сигнал 1: BUY YES @ yesPrice (основная позиция)
Сигнал 2: BUY NO @ (1 - yesPrice) (хедж)
```

### Шаг 5: Валидация
```
Проверка minimum_order_size
Проверка диапазона цен [0.01, 0.99]
```

---

## Математика хеджирования

### Формулы расчета:

**1. Основная позиция (YES):**
```
yesSize = floor(totalCapital / yesPrice)
yesCost = yesSize * yesPrice
```

Пример: $100 / $0.97 = 103 токена, стоимость = $99.91

**2. Максимальный приемлемый убыток (MAL):**
```
maxLoss = yesCost * maxAcceptableLoss
```

Пример: $99.91 * 0.20 = $19.98 (20% от позиции)

**3. Необходимая выплата от хеджа:**
```
hedgePayoutNeeded = yesCost - maxLoss
```

Пример: $99.91 - $19.98 = $79.93

**4. Размер хеджа (NO):**
```
noProfitPerShare = 1 - noPrice
noSize = ceil(hedgePayoutNeeded / noProfitPerShare)
noCost = noSize * noPrice
```

Пример:
- noPrice = 1 - 0.97 = $0.03
- noProfitPerShare = 1 - $0.03 = $0.97
- noSize = ceil($79.93 / $0.97) = 83 токена
- noCost = 83 * $0.03 = $2.49

**5. Итоговые сценарии:**

**Сценарий А: YES выигрывает (97% вероятность):**
```
yesProfit = yesSize * (1 - yesPrice) = 103 * $0.03 = $3.09
noLoss = -noCost = -$2.49
netProfitIfWin = yesProfit - noCost = $3.09 - $2.49 = $0.60
ROI = ($0.60 / $102.40) * 100 = 0.59%
```

**Сценарий Б: NO выигрывает (3% вероятность):**
```
yesLoss = -yesCost = -$99.91
noProfit = noSize * (1 - noPrice) = 83 * $0.97 = $80.51
netLossIfLose = -$99.91 + $80.51 = -$19.40
ROI = (-$19.40 / $102.40) * 100 = -18.95%
```

### Результат:
- Прибыль при успехе: +$0.60 (0.59%)
- Убыток при неудаче: -$19.40 (18.95%, защищено хеджем от 100% потери)
- Математическое ожидание: (0.97 * $0.60) + (0.03 * -$19.40) = $0.58 - $0.58 = $0

---

## Логика выхода из позиции

### Условия раннего выхода:

**1. Достижение порога (earlyExitThreshold):**
```
if (currentPrice >= 0.99):
    → Продать позицию
    → Зафиксировать прибыль
```
Причина: При 99% гэп минимален, нет смысла ждать.

**2. Приближение к разрешению (<24 часов):**
```
if (hoursUntilEnd < 24):
    → Продать позицию
    → Избежать риска манипуляций
```
Причина: В последние часы возможна волатильность.

**3. Stop Loss (цена упала ниже minProbability):**
```
if (currentPrice < 0.95):
    → Продать позицию
    → Ограничить убытки
```
Причина: Условия стратегии нарушены, исход неочевиден.

**4. Автоматическое разрешение:**
```
if (market.closed && winner == YES):
    → Получить выплату
if (market.closed && winner == NO):
    → Активировать хедж
```

---

## Управление рисками

### Риски и защита:

**1. Черный лебедь (маловероятное событие):**
- **Риск:** YES @ 97% проигрывает
- **Защита:** Хедж в NO ограничивает убыток до 20%
- **Пример:** Вместо -100% теряем только -20%

**2. Манипуляция рынка:**
- **Риск:** Искусственное движение цены
- **Защита:** Ранний выход за 24 часа до разрешения

**3. Застревание позиции:**
- **Риск:** Нет ликвидности для выхода
- **Защита:** Фильтр minVolume, проверка orderbook

**4. Каскад убытков:**
- **Риск:** Одновременно проигрывают несколько рынков
- **Защита:** maxMarkets ограничивает экспозицию

**5. Недостаточная доходность:**
- **Риск:** Хедж "съедает" всю прибыль
- **Защита:** Валидация netProfitIfWin > 0 перед входом

---

## Примеры работы

### Пример 1: Успешная сделка

**Рынок:** "Biden wins Pennsylvania?"
- YES: 96% ($0.96)
- NO: 4% ($0.04)
- До разрешения: 3 дня

**Позиция:**
- Капитал: $100
- YES: 104 @ $0.96 = $99.84
- NO: 21 @ $0.04 = $0.84 (страховка)
- Всего: $100.68

**Разрешение: YES выигрывает**
- YES profit: 104 * $0.04 = $4.16
- NO loss: -$0.84
- Net: $4.16 - $0.84 = $3.32
- ROI: 3.3%

**Годовая доходность (если 1 сделка в неделю):**
- 52 недели * 3.3% = 171% APY

---

### Пример 2: Сработал хедж

**Рынок:** "Stock market up this month?"
- YES: 98% ($0.98)
- NO: 2% ($0.02)
- До разрешения: 1 день

**Позиция:**
- Капитал: $100
- YES: 102 @ $0.98 = $99.96
- NO: 82 @ $0.02 = $1.64 (страховка 20% MAL)
- Всего: $101.60

**Разрешение: NO выигрывает (черный лебедь!)**
- YES loss: -$99.96
- NO profit: 82 * $0.98 = $80.36
- Net: -$99.96 + $80.36 = -$19.60
- ROI: -19.3%

**Без хеджа был бы убыток -100%!**

---

### Пример 3: Ранний выход

**Рынок:** "Trump tweet before Friday?"
- YES: 95% ($0.95)
- NO: 5% ($0.05)
- До разрешения: 7 дней

**День 1:** Вход в позицию
**День 5:** Цена выросла до 99% → ранний выход
- Прибыль от роста цены: +4%
- Не ждали разрешения, зафиксировали

---

## Оптимизация параметров

### Как выбрать параметры:

**minProbability и maxProbability:**
- **95-99%** - консервативно, меньше возможностей, меньше риск
- **80-99%** - агрессивно, больше возможностей, больше риск
- **90-95%** - средний баланс

**maxAcceptableLoss:**
- **10%** - дорогая страховка, низкая прибыль
- **20%** - оптимальный баланс
- **30%** - дешевая страховка, высокий риск

**maxDaysToResolution:**
- **7 дней** - быстрый оборот капитала
- **14 дней** - средний темп
- **30 дней** - медленный оборот, больше возможностей

**orderSize:**
- Зависит от капитала
- Рекомендация: не более 10% от портфеля на 1 рынок
- С учетом maxMarkets = 10: каждый рынок = 1% портфеля

---

## Метрики эффективности

### KPI стратегии:

**Win Rate:**
- Ожидаемый: 95-99% (соответствует вероятностям)
- Реальный: может быть ниже из-за черных лебедей

**Average Profit (при выигрыше):**
- Зависит от спреда
- Обычно: 1-5% за сделку

**Average Loss (при проигрыше):**
- Ограничен maxAcceptableLoss
- Обычно: 10-20% за сделку

**Expected Value:**
```
EV = (winRate * avgProfit) + ((1 - winRate) * avgLoss)
```

Пример:
- Win rate: 96%
- Avg profit: 3%
- Avg loss: -20%
```
EV = (0.96 * 3%) + (0.04 * -20%) = 2.88% - 0.8% = 2.08%
```

**Годовая доходность:**
```
APY = EV * количество сделок в год
```

Если 2 сделки в неделю:
```
APY = 2.08% * 104 = 216%
```

---

## Важные замечания

### ⚠️ Ограничения стратегии:

1. **Требуется дата разрешения:** Рынки без `end_date_iso` не подходят

2. **Малая прибыль:** Доходность 1-5% за сделку требует частых возможностей

3. **Хедж съедает прибыль:** При высоких вероятностях (>98%) страховка очень дорогая

4. **Риск коррелированных убытков:** Если черный лебедь системный (например крах биржи), могут проиграть несколько рынков одновременно

5. **Минимальный размер ордера:** Малые позиции могут не проходить `minimum_order_size`

6. **Ликвидность:** Для выхода нужна достаточная ликвидность в orderbook

---

## Best Practices

### Рекомендации по использованию:

✅ **DO:**
- Диверсифицируйте: несколько рынков одновременно
- Проверяйте ликвидность через orderbook перед входом
- Используйте test:endgame для анализа возможностей
- Начните с малых позиций для обкатки
- Следите за датами разрешения
- Фиксируйте прибыль при достижении 99%

❌ **DON'T:**
- Не ставьте весь капитал на один рынок
- Не игнорируйте минимальный размер ордера
- Не входите в рынки без даты разрешения
- Не отключайте хедж (это защита!)
- Не используйте кредитное плечо
- Не торгуйте рынками с низкой ликвидностью

---

## Сравнение с другими стратегиями

### Endgame vs Market Making:
- **Market Making:** Прибыль от спреда, требует постоянного управления
- **Endgame:** Прибыль от разрешения, hold до конца

### Endgame vs High Confidence:
- **High Confidence:** 80%+ без хеджа, высокий риск
- **Endgame:** 95-99% с хеджем, защищенный риск

### Endgame vs Directional Trading:
- **Directional:** Ставка на изменение цены
- **Endgame:** Ставка на известный исход
